<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Calorie Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #020617;
      --bg-card: #0b1120;
      --bg-soft: #020617;
      --border-subtle: #1f2937;
      --border-strong: #4b5563;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.14);
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.16);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --radius-lg: 18px;
      --radius-md: 10px;
      --shadow-card: 0 18px 40px rgba(0, 0, 0, 0.45);
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #020617 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 18px 14px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* HEADER */

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 2px 2px 4px;
    }

    .header-left {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background: radial-gradient(circle at 0 0, #22c55e, #16a34a 45%, #0ea5e9 100%);
      box-shadow: 0 12px 24px rgba(34, 197, 94, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      color: #022c22;
      flex-shrink: 0;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.02em;
      display: flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
    }

    .badge {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 3px 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .title-block p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      border: none;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease,
        border-color 0.15s ease;
    }

    .btn-muted {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(75, 85, 99, 0.9);
      color: var(--text-muted);
      box-shadow: none;
    }

    .btn-muted:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.9);
    }

    /* LAYOUT */

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-card);
      padding: 16px 16px 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-header-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-header-main h2 {
      margin: 0;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .card-header-main span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.98);
      padding: 4px 9px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, var(--accent) 0, #15803d 55%, transparent 60%);
    }

    /* SUMMARY CARD */

    .goal-row {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .field input,
    .field select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
    }

    .field input:focus,
    .field select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .field input[type="number"]::-webkit-inner-spin-button,
    .field input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .field input[type="number"] {
      -moz-appearance: textfield;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #16a34a);
      border: 1px solid #16a34a;
      color: #022c22;
      box-shadow: 0 10px 22px rgba(34, 197, 94, 0.45);
      font-size: 0.82rem;
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 5px 12px rgba(34, 197, 94, 0.45);
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .stat {
      border-radius: 14px;
      background: radial-gradient(circle at -10% -20%, var(--accent-soft), #020617);
      border: 1px solid rgba(31, 41, 55, 0.95);
      padding: 9px 10px;
      box-shadow: var(--shadow-soft);
    }

    .stat.secondary {
      background: #020617;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .stat-unit {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .stat-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .summary-layout {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-top: 6px;
    }

    .ring {
      width: 120px;
      height: 120px;
      position: relative;
      flex-shrink: 0;
    }

    .ring svg {
      transform: rotate(-90deg);
    }

    .ring circle {
      transition: stroke-dashoffset 0.3s ease;
    }

    .ring-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .ring-percent {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .ring-label {
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    .ring-chip {
      font-size: 0.74rem;
      border-radius: 999px;
      padding: 2px 8px;
      margin-top: 4px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: rgba(15, 23, 42, 0.98);
    }

    .info-stack {
      flex: 1;
      font-size: 0.8rem;
    }

    .alert {
      border-radius: 12px;
      padding: 6px 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.78rem;
    }

    .alert-icon {
      font-size: 0.9rem;
      line-height: 1;
      margin-top: 1px;
    }

    .alert-info {
      background: rgba(37, 99, 235, 0.08);
      border: 1px solid rgba(37, 99, 235, 0.5);
      color: #bfdbfe;
    }

    .alert-danger {
      background: var(--danger-soft);
      border: 1px solid rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }

    .legend-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .swatch-consumed {
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
    }

    .swatch-remaining {
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
    }

    .footer-note {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 6px;
      text-align: right;
    }

    /* LOG CARD */

    .date-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .date-picker {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .date-picker input[type="date"] {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      padding: 5px 8px;
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 0.8rem;
      outline: none;
    }

    .text-muted {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    form {
      margin-top: 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) 1.1fr 0.9fr auto;
      gap: 8px;
      margin-bottom: 8px;
    }

    .divider {
      border-top: 1px dashed rgba(55, 65, 81, 0.9);
      margin: 8px 0;
    }

    .entries-list {
      max-height: 360px;
      overflow-y: auto;
      margin-right: -4px;
      padding-right: 4px;
    }

    .entry {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) 0.9fr auto;
      gap: 6px;
      align-items: center;
      padding: 7px 9px;
      margin-bottom: 6px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(30, 64, 175, 0.55);
    }

    .entry-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .entry-name {
      font-size: 0.86rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .entry-meta {
      font-size: 0.72rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .badge-pill {
      border-radius: 999px;
      padding: 1px 7px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .entry-calories {
      font-size: 0.92rem;
      font-weight: 600;
      text-align: right;
    }

    .entry-actions {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
    }

    .btn-icon {
      border-radius: 999px;
      padding: 4px 7px;
      border: 1px solid rgba(75, 85, 99, 0.95);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-muted);
      font-size: 0.7rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-danger {
      background: var(--danger-soft);
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }

    .empty {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      padding: 18px 8px 4px;
    }

    .entries-list::-webkit-scrollbar {
      width: 4px;
    }

    .entries-list::-webkit-scrollbar-thumb {
      background: rgba(75, 85, 99, 0.85);
      border-radius: 999px;
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
      .ring {
        width: 110px;
        height: 110px;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 12px 10px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .title-block h1 {
        font-size: 1.18rem;
      }

      .card {
        padding: 13px 12px 11px;
      }

      .summary-layout {
        flex-direction: column;
        align-items: stretch;
      }

      .ring {
        margin: 0 auto;
      }

      .stats-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .form-grid {
        grid-template-columns: minmax(0, 1.2fr) 1.1fr;
        grid-template-rows: auto auto;
      }

      .form-grid .field:nth-child(3) {
        grid-column: 1 / 2;
      }

      .form-grid .btn-primary {
        grid-column: 2 / 3;
        grid-row: 2 / 3;
        justify-self: stretch;
      }

      .entries-list {
        max-height: 280px;
      }

      .entry {
        grid-template-columns: minmax(0, 1.5fr) 0.9fr;
        grid-template-rows: auto auto;
      }

      .entry-actions {
        grid-column: 1 / -1;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-left">
        <div class="logo">CT</div>
        <div class="title-block">
          <h1>
            Calorie Tracker
            <span class="badge">Local cache · Built-in model</span>
          </h1>
          <p>Type food + grams · calories are estimated automatically.</p>
        </div>
      </div>
      <button id="resetAllBtn" class="btn btn-muted" type="button">
        Reset all data
      </button>
    </header>

    <main>
      <!-- LEFT: SUMMARY -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-main">
            <h2>Today summary</h2>
            <span id="currentDateLabel"></span>
          </div>
          <div class="chip">
            <span class="chip-dot"></span>
            <span>Stored only in this browser</span>
          </div>
        </div>

        <div class="goal-row">
          <div class="field">
            <label for="dailyGoal">Daily calorie goal</label>
            <input id="dailyGoal" type="number" min="0" placeholder="e.g. 2200" />
          </div>
          <button id="saveGoalBtn" class="btn btn-primary" type="button">
            Save goal
          </button>
        </div>

        <div class="stats-row">
          <div class="stat">
            <div class="stat-label">Consumed</div>
            <div class="stat-value">
              <span id="statConsumed">0</span>
              <span class="stat-unit">kcal</span>
            </div>
            <div class="stat-sub" id="statConsumedCount">0 entries</div>
          </div>
          <div class="stat secondary">
            <div class="stat-label">Remaining</div>
            <div class="stat-value">
              <span id="statRemaining">0</span>
              <span class="stat-unit">kcal</span>
            </div>
            <div class="stat-sub" id="statRemainingHint">Set a goal to see remaining</div>
          </div>
          <div class="stat secondary">
            <div class="stat-label">Balance</div>
            <div class="stat-value">
              <span id="statBalance">0</span>
              <span class="stat-unit">kcal</span>
            </div>
            <div class="stat-sub" id="statBalanceHint">Goal − Consumed</div>
          </div>
        </div>

        <div class="summary-layout">
          <div class="ring">
            <svg width="120" height="120">
              <defs>
                <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#22c55e" />
                  <stop offset="50%" stop-color="#16a34a" />
                  <stop offset="100%" stop-color="#38bdf8" />
                </linearGradient>
              </defs>
              <circle
                cx="60"
                cy="60"
                r="48"
                stroke="rgba(31,41,55,0.9)"
                stroke-width="8"
                fill="none"
              ></circle>
              <circle
                id="progressCircle"
                cx="60"
                cy="60"
                r="48"
                stroke="url(#ringGradient)"
                stroke-width="8"
                stroke-linecap="round"
                fill="none"
                stroke-dasharray="301.59"
                stroke-dashoffset="301.59"
              ></circle>
            </svg>
            <div class="ring-center">
              <div class="ring-percent" id="progressPercent">0%</div>
              <div class="ring-label" id="progressLabel">of daily goal</div>
              <div class="ring-chip" id="progressBadge">Set a goal to begin</div>
            </div>
          </div>

          <div class="info-stack">
            <div class="alert alert-info">
              <div class="alert-icon">ℹ</div>
              <p id="infoText">
                Everything (goal and entries) is stored in <strong>localStorage</strong>.
                Calories are estimated on-device by a small rule-based model.
              </p>
            </div>
            <div id="overGoalAlert" class="alert alert-danger" style="display:none;">
              <div class="alert-icon">!</div>
              <p id="overGoalText"></p>
            </div>
            <div class="legend-row">
              <div class="legend-item">
                <span class="legend-swatch swatch-consumed"></span>
                <span>Consumed</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch swatch-remaining"></span>
                <span>Remaining</span>
              </div>
            </div>
          </div>
        </div>

        <div class="footer-note">
          Change the date on the right to review or edit previous days.
        </div>
      </section>

      <!-- RIGHT: LOG -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-main">
            <h2>Log meals</h2>
            <span class="text-muted">Food name + grams → model estimates calories.</span>
          </div>
          <div class="date-row">
            <div class="date-picker">
              <span>Day</span>
              <input id="datePicker" type="date" />
            </div>
            <button id="clearDayBtn" class="btn-icon btn-danger" type="button">
              Clear day
            </button>
          </div>
        </div>

        <form id="entryForm" autocomplete="off">
          <div class="form-grid">
            <div class="field">
              <label for="mealName">Food / description</label>
              <input
                id="mealName"
                type="text"
                placeholder="e.g. chicken wrap, banana, pizza slice"
                required
              />
            </div>
            <div class="field">
              <label for="mealGrams">Portion (grams)</label>
              <input
                id="mealGrams"
                type="number"
                min="1"
                inputmode="numeric"
                placeholder="e.g. 120"
                required
              />
            </div>
            <div class="field">
              <label for="mealCategory">Category</label>
              <select id="mealCategory">
                <option value="auto">Auto detect</option>
                <option value="fruit">Fruit</option>
                <option value="vegetable">Vegetable</option>
                <option value="lean_protein">Lean protein</option>
                <option value="fatty_protein">Fatty protein</option>
                <option value="starch">Rice / pasta / potato</option>
                <option value="bread">Bread / baked</option>
                <option value="snack_sweet">Sweet snack / dessert</option>
                <option value="snack_savory">Chips / savory snack</option>
                <option value="fast_food">Fast food / mixed meal</option>
                <option value="cheese">Cheese</option>
                <option value="nuts">Nuts / seeds</option>
                <option value="drink_sugary">Sugary drink / juice</option>
                <option value="drink_zero">Zero-cal drink</option>
              </select>
            </div>
            <button class="btn btn-primary" type="submit">
              + Add
            </button>
          </div>
        </form>

        <div class="divider"></div>

        <div id="entriesList" class="entries-list"></div>
        <div id="emptyState" class="empty">
          No entries for this day yet. Add your first one above.
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "calorieTrackerData_v3";

      function loadData() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return { goal: null, entries: [] };
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return { goal: null, entries: [] };
          return {
            goal: typeof parsed.goal === "number" ? parsed.goal : null,
            entries: Array.isArray(parsed.entries)
              ? parsed.entries.map((e) => ({
                  id: e.id || String(Math.random()),
                  date: e.date,
                  name: e.name,
                  grams: Number(e.grams) || 0,
                  calories: Number(e.calories) || 0,
                  category: e.category || "auto",
                  modelBasis: e.modelBasis || null,
                }))
              : [],
          };
        } catch {
          return { goal: null, entries: [] };
        }
      }

      function saveData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      const data = loadData();

      /* DOM ELEMENTS */

      const dailyGoalInput = document.getElementById("dailyGoal");
      const saveGoalBtn = document.getElementById("saveGoalBtn");
      const resetAllBtn = document.getElementById("resetAllBtn");

      const statConsumedEl = document.getElementById("statConsumed");
      const statConsumedCountEl = document.getElementById("statConsumedCount");
      const statRemainingEl = document.getElementById("statRemaining");
      const statRemainingHintEl = document.getElementById("statRemainingHint");
      const statBalanceEl = document.getElementById("statBalance");
      const statBalanceHintEl = document.getElementById("statBalanceHint");

      const progressCircleEl = document.getElementById("progressCircle");
      const progressPercentEl = document.getElementById("progressPercent");
      const progressLabelEl = document.getElementById("progressLabel");
      const progressBadgeEl = document.getElementById("progressBadge");

      const infoTextEl = document.getElementById("infoText");
      const overGoalAlertEl = document.getElementById("overGoalAlert");
      const overGoalTextEl = document.getElementById("overGoalText");

      const currentDateLabelEl = document.getElementById("currentDateLabel");
      const datePickerEl = document.getElementById("datePicker");
      const clearDayBtn = document.getElementById("clearDayBtn");

      const entryForm = document.getElementById("entryForm");
      const mealNameInput = document.getElementById("mealName");
      const mealGramsInput = document.getElementById("mealGrams");
      const mealCategorySelect = document.getElementById("mealCategory");

      const entriesListEl = document.getElementById("entriesList");
      const emptyStateEl = document.getElementById("emptyState");

      const circleRadius = 48;
      const circleCircumference = 2 * Math.PI * circleRadius;

      /* DATES */

      function todayISO() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + day;
      }

      function formatDateLabel(dateStr) {
        const date = new Date(dateStr + "T00:00");
        const todayStr = todayISO();
        if (dateStr === todayStr) return "Today";
        const yest = new Date();
        yest.setDate(yest.getDate() - 1);
        const tomo = new Date();
        tomo.setDate(tomo.getDate() + 1);
        const iso = date.toISOString().slice(0, 10);
        if (iso === yest.toISOString().slice(0, 10)) return "Yesterday";
        if (iso === tomo.toISOString().slice(0, 10)) return "Tomorrow";
        return date.toLocaleDateString(undefined, {
          weekday: "short",
          month: "short",
          day: "numeric",
        });
      }

      function setCurrentDate(dateStr) {
        datePickerEl.value = dateStr;
        currentDateLabelEl.textContent = formatDateLabel(dateStr);
      }

      function getSelectedDate() {
        return datePickerEl.value || todayISO();
      }

      /* SIMPLE CALORIE MODEL */

      // Typical kcal per 100 g for categories (approximate, from common nutrition data).
      const CATEGORY_PER100 = {
        fruit: 60,
        vegetable: 30,
        lean_protein: 165,
        fatty_protein: 250,
        starch: 140, // rice/pasta/potato average
        bread: 250,
        snack_sweet: 430,
        snack_savory: 540,
        fast_food: 260,
        cheese: 380,
        nuts: 600,
        drink_sugary: 45,
        drink_zero: 1,
      };

      // Keyword-based overrides (per 100 g), small on-device “model”.
      const KEYWORD_MODEL = [
        { words: ["banana"], per100: 89, basis: "banana (per 100 g)" },
        { words: ["apple"], per100: 52, basis: "apple (per 100 g)" },
        { words: ["orange"], per100: 47, basis: "orange (per 100 g)" },
        { words: ["strawberry", "strawberries"], per100: 33, basis: "strawberry (per 100 g)" },
        { words: ["grape", "grapes"], per100: 69, basis: "grapes (per 100 g)" },

        { words: ["chicken breast", "grilled chicken"], per100: 165, basis: "grilled chicken breast (per 100 g)" },
        { words: ["salmon"], per100: 208, basis: "salmon (per 100 g)" },
        { words: ["beef", "steak"], per100: 250, basis: "beef (per 100 g)" },

        { words: ["rice"], per100: 130, basis: "cooked white rice (per 100 g)" },
        { words: ["brown rice"], per100: 111, basis: "cooked brown rice (per 100 g)" },
        { words: ["pasta"], per100: 160, basis: "cooked pasta (per 100 g)" },
        { words: ["potato", "fries", "fry"], per100: 190, basis: "fried potatoes (per 100 g)" },

        { words: ["bread"], per100: 260, basis: "bread (per 100 g)" },
        { words: ["pizza"], per100: 270, basis: "pizza (per 100 g)" },
        { words: ["burger"], per100: 260, basis: "burger (per 100 g)" },

        { words: ["chips", "crisps"], per100: 540, basis: "potato chips (per 100 g)" },
        { words: ["cookie", "cookies"], per100: 480, basis: "cookies (per 100 g)" },
        { words: ["chocolate"], per100: 540, basis: "milk chocolate (per 100 g)" },

        { words: ["coke", "cola", "soda"], per100: 40, basis: "sugary soft drink (per 100 g)" },
        { words: ["juice"], per100: 45, basis: "fruit juice (per 100 g)" },
        { words: ["coffee", "tea"], per100: 2, basis: "plain coffee/tea (per 100 g)" },

        { words: ["cheese"], per100: 380, basis: "cheese (per 100 g)" },
        { words: ["peanut", "peanuts", "peanut butter"], per100: 588, basis: "peanuts / peanut butter (per 100 g)" },
        { words: ["almond", "almonds"], per100: 575, basis: "almonds (per 100 g)" },
      ];

      function detectCategoryFromText(text) {
        const t = text.toLowerCase();
        if (t.match(/banana|apple|orange|strawber|grape/)) return "fruit";
        if (t.match(/broccoli|carrot|lettuce|salad|spinach|cucumber/)) return "vegetable";
        if (t.match(/chicken|turkey|tuna|cod/)) return "lean_protein";
        if (t.match(/salmon|pork belly|bacon/)) return "fatty_protein";
        if (t.match(/rice|pasta|noodle|potato|mashed/)) return "starch";
        if (t.match(/bread|bun|bagel|toast/)) return "bread";
        if (t.match(/cake|cookie|ice cream|brownie|donut|muffin/)) return "snack_sweet";
        if (t.match(/chips|crisps|nacho|pretzel/)) return "snack_savory";
        if (t.match(/pizza|burger|fries|kebab|shawarma/)) return "fast_food";
        if (t.match(/cheese/)) return "cheese";
        if (t.match(/peanut|almond|walnut|cashew|nut/)) return "nuts";
        if (t.match(/juice|soda|cola|coke|sprite|fanta|energy drink/)) return "drink_sugary";
        if (t.match(/diet|zero sugar|zero-cal|zero cal/)) return "drink_zero";
        return "fast_food"; // fallback generic mixed meal
      }

      function estimateCalories(name, grams, userCategory) {
        const text = name.toLowerCase();

        let keywordMatch = null;
        for (const rule of KEYWORD_MODEL) {
          if (rule.words.some((w) => text.includes(w))) {
            keywordMatch = rule;
            break;
          }
        }

        const category =
          userCategory && userCategory !== "auto"
            ? userCategory
            : detectCategoryFromText(text);

        let per100 = null;
        let basis = "";

        if (keywordMatch) {
          per100 = keywordMatch.per100;
          basis = keywordMatch.basis;
        } else if (CATEGORY_PER100[category] != null) {
          per100 = CATEGORY_PER100[category];
          basis = "category: " + category.replace("_", " ");
        } else {
          per100 = 220; // very generic mixed-meal fallback
          basis = "generic mixed meal";
        }

        const kcal = Math.round((per100 * grams) / 100);
        return {
          calories: kcal,
          per100: per100,
          category,
          basis,
        };
      }

      /* ENTRIES / STATS */

      function getEntriesForDate(dateStr) {
        return data.entries.filter((e) => e.date === dateStr);
      }

      function addEntry(name, grams, category, est) {
        const entry = {
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          date: getSelectedDate(),
          name: name.trim(),
          grams,
          calories: est.calories,
          category,
          modelBasis: est.basis + " · " + est.per100 + " kcal / 100 g",
        };
        data.entries.push(entry);
        saveData(data);
        updateStatsAndUI();
      }

      function deleteEntry(id) {
        const idx = data.entries.findIndex((e) => e.id === id);
        if (idx === -1) return;
        data.entries.splice(idx, 1);
        saveData(data);
        updateStatsAndUI();
      }

      function clearDay(dateStr) {
        data.entries = data.entries.filter((e) => e.date !== dateStr);
        saveData(data);
        updateStatsAndUI();
      }

      function renderEntries(dateStr) {
        const entries = getEntriesForDate(dateStr);
        entriesListEl.innerHTML = "";
        if (entries.length === 0) {
          emptyStateEl.style.display = "block";
          return;
        }
        emptyStateEl.style.display = "none";

        entries
          .slice()
          .sort((a, b) => a.id.localeCompare(b.id))
          .forEach((entry) => {
            const root = document.createElement("div");
            root.className = "entry";

            const main = document.createElement("div");
            main.className = "entry-main";

            const nameEl = document.createElement("div");
            nameEl.className = "entry-name";
            nameEl.textContent = entry.name || "(no description)";
            main.appendChild(nameEl);

            const meta = document.createElement("div");
            meta.className = "entry-meta";

            const gramsBadge = document.createElement("span");
            gramsBadge.className = "badge-pill";
            gramsBadge.textContent = entry.grams + " g";
            meta.appendChild(gramsBadge);

            if (entry.category && entry.category !== "auto") {
              const catBadge = document.createElement("span");
              catBadge.className = "badge-pill";
              catBadge.textContent = entry.category.replace("_", " ");
              meta.appendChild(catBadge);
            }

            if (entry.modelBasis) {
              const basisBadge = document.createElement("span");
              basisBadge.className = "badge-pill";
              basisBadge.textContent = entry.modelBasis;
              meta.appendChild(basisBadge);
            }

            main.appendChild(meta);

            const calEl = document.createElement("div");
            calEl.className = "entry-calories";
            calEl.textContent = entry.calories + " kcal";

            const actions = document.createElement("div");
            actions.className = "entry-actions";

            const fineTuneBtn = document.createElement("button");
            fineTuneBtn.className = "btn-icon";
            fineTuneBtn.type = "button";
            fineTuneBtn.textContent = "Adjust";
            fineTuneBtn.addEventListener("click", function () {
              const current = entry.calories;
              const v = prompt(
                "Adjust calories for this entry:",
                String(current)
              );
              if (v == null) return;
              const num = Number(v);
              if (!Number.isFinite(num) || num <= 0) return;
              entry.calories = Math.round(num);
              saveData(data);
              updateStatsAndUI();
            });

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn-icon btn-danger";
            deleteBtn.type = "button";
            deleteBtn.textContent = "Delete";
            deleteBtn.addEventListener("click", function () {
              deleteEntry(entry.id);
            });

            actions.appendChild(fineTuneBtn);
            actions.appendChild(deleteBtn);

            root.appendChild(main);
            root.appendChild(calEl);
            root.appendChild(actions);

            entriesListEl.appendChild(root);
          });
      }

      function updateStatsAndUI() {
        const dateStr = getSelectedDate();
        const entries = getEntriesForDate(dateStr);
        const total = entries.reduce((sum, e) => sum + e.calories, 0);

        statConsumedEl.textContent = String(total);
        statConsumedCountEl.textContent =
          entries.length === 1 ? "1 entry" : entries.length + " entries";

        if (typeof data.goal === "number" && data.goal > 0) {
          const remaining = Math.max(data.goal - total, 0);
          const balance = data.goal - total;

          statRemainingEl.textContent = String(remaining);
          statRemainingHintEl.textContent =
            remaining === 0
              ? "Goal reached or exceeded"
              : "You can still consume " + remaining + " kcal";

          statBalanceEl.textContent = String(balance);
          statBalanceHintEl.textContent =
            balance >= 0 ? "Under daily goal" : "Over daily goal";

          const progress = total <= 0 ? 0 : Math.min((total / data.goal) * 100, 200);
          const percentText = Math.round(
            Math.min((total / data.goal) * 100, 999)
          );
          const offset =
            circleCircumference * (1 - Math.min(progress / 100, 1));
          progressCircleEl.style.strokeDasharray = circleCircumference.toFixed(2);
          progressCircleEl.style.strokeDashoffset = offset.toFixed(2);
          progressPercentEl.textContent = percentText + "%";
          progressLabelEl.textContent = "of " + data.goal + " kcal goal";

          if (total === 0) {
            progressBadgeEl.textContent = "Start logging meals to see progress.";
          } else if (progress < 70) {
            progressBadgeEl.textContent = "Plenty of room left today.";
          } else if (progress <= 100) {
            progressBadgeEl.textContent = "You’re close to your goal.";
          } else {
            progressBadgeEl.textContent = "You’re above today’s goal.";
          }

          if (balance < 0) {
            overGoalTextEl.textContent =
              "You are " +
              Math.abs(balance) +
              " kcal over your daily goal for this day.";
            overGoalAlertEl.style.display = "flex";
          } else {
            overGoalAlertEl.style.display = "none";
          }

          infoTextEl.innerHTML =
            "Goal and entries are cached locally. Calories come from a small, built-in rule-based model; you can fine-tune each entry if needed.";
        } else {
          statRemainingEl.textContent = "0";
          statRemainingHintEl.textContent = "Set a goal to see remaining";
          statBalanceEl.textContent = "0";
          statBalanceHintEl.textContent = "Goal − Consumed";

          progressCircleEl.style.strokeDasharray = circleCircumference.toFixed(2);
          progressCircleEl.style.strokeDashoffset =
            circleCircumference.toFixed(2);
          progressPercentEl.textContent = "0%";
          progressLabelEl.textContent = "of daily goal";
          progressBadgeEl.textContent = "Set a goal to begin";
          overGoalAlertEl.style.display = "none";

          infoTextEl.innerHTML =
            "You can log food without a goal. Everything stays in this browser; the model estimates calories automatically from your inputs.";
        }

        renderEntries(dateStr);
      }

      /* INIT / EVENTS */

      function init() {
        const today = todayISO();
        setCurrentDate(today);
        datePickerEl.value = today;

        if (typeof data.goal === "number" && data.goal > 0) {
          dailyGoalInput.value = String(data.goal);
        }

        updateStatsAndUI();
      }

      entryForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const name = mealNameInput.value.trim();
        const grams = Number(mealGramsInput.value);
        const category = mealCategorySelect.value || "auto";
        if (!name) {
          mealNameInput.focus();
          return;
        }
        if (!Number.isFinite(grams) || grams <= 0) {
          mealGramsInput.focus();
          return;
        }

        const est = estimateCalories(name, grams, category);
        addEntry(name, Math.round(grams), est.category, est);

        mealNameInput.value = "";
        mealGramsInput.value = "";
        mealCategorySelect.value = "auto";
        mealNameInput.focus();
      });

      saveGoalBtn.addEventListener("click", function () {
        const v = dailyGoalInput.value.trim();
        if (!v) {
          data.goal = null;
        } else {
          const n = Number(v);
          if (!Number.isFinite(n) || n <= 0) {
            dailyGoalInput.focus();
            return;
          }
          data.goal = Math.round(n);
        }
        saveData(data);
        updateStatsAndUI();
      });

      datePickerEl.addEventListener("change", function () {
        if (!datePickerEl.value) {
          datePickerEl.value = todayISO();
        }
        currentDateLabelEl.textContent = formatDateLabel(getSelectedDate());
        updateStatsAndUI();
      });

      clearDayBtn.addEventListener("click", function () {
        const dateStr = getSelectedDate();
        if (!getEntriesForDate(dateStr).length) return;
        if (
          confirm(
            "Delete all entries for " +
              formatDateLabel(dateStr) +
              "?\nThis cannot be undone."
          )
        ) {
          clearDay(dateStr);
        }
      });

      resetAllBtn.addEventListener("click", function () {
        if (
          confirm(
            "This will erase all entries and your goal from this browser. Continue?"
          )
        ) {
          localStorage.removeItem(STORAGE_KEY);
          const fresh = loadData();
          data.goal = fresh.goal;
          data.entries = fresh.entries;
          dailyGoalInput.value = "";
          setCurrentDate(todayISO());
          updateStatsAndUI();
        }
      });

      init();
    })();
  </script>
</body>
</html>
